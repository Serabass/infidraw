# Упрощенная версия без секретов - для dev окружения
# Используй эту версию если у тебя нет секрета postgres-credentials
apiVersion: v1
kind: ConfigMap
metadata:
  name: migrate-bbox-sql
  namespace: infidraw
data:
  migrate-bbox.sql: |
    -- Migrate bbox fields - fill min_x, min_y, max_x, max_y for existing strokes

    -- Добавляем колонки если их еще нет
    DO $$ 
    BEGIN
      IF NOT EXISTS (SELECT 1 FROM information_schema.columns 
                     WHERE table_name = 'stroke_events' AND column_name = 'min_x') THEN
        ALTER TABLE stroke_events 
          ADD COLUMN min_x DOUBLE PRECISION,
          ADD COLUMN min_y DOUBLE PRECISION,
          ADD COLUMN max_x DOUBLE PRECISION,
          ADD COLUMN max_y DOUBLE PRECISION;
      END IF;
    END $$;

    -- Обновляем bbox для записей где они еще не заполнены
    UPDATE stroke_events
    SET 
      min_x = (
        SELECT MIN((point->>0)::double precision)
        FROM jsonb_array_elements(stroke_data->'points') AS point
      ),
      min_y = (
        SELECT MIN((point->>1)::double precision)
        FROM jsonb_array_elements(stroke_data->'points') AS point
      ),
      max_x = (
        SELECT MAX((point->>0)::double precision)
        FROM jsonb_array_elements(stroke_data->'points') AS point
      ),
      max_y = (
        SELECT MAX((point->>1)::double precision)
        FROM jsonb_array_elements(stroke_data->'points') AS point
      )
    WHERE event_type = 'stroke_created'
      AND stroke_data IS NOT NULL
      AND stroke_data->'points' IS NOT NULL
      AND jsonb_array_length(stroke_data->'points') > 0
      AND (min_x IS NULL OR min_y IS NULL OR max_x IS NULL OR max_y IS NULL);

    -- Создаем индексы если их еще нет
    CREATE INDEX IF NOT EXISTS idx_stroke_coords ON stroke_events(min_x, min_y, max_x, max_y) 
      WHERE event_type = 'stroke_created' AND min_x IS NOT NULL;

    -- Показываем статистику
    SELECT 
      COUNT(*) as total_strokes,
      COUNT(min_x) as strokes_with_bbox,
      COUNT(*) - COUNT(min_x) as strokes_without_bbox
    FROM stroke_events
    WHERE event_type = 'stroke_created';
---
apiVersion: batch/v1
kind: Job
metadata:
  name: migrate-bbox
  namespace: infidraw
spec:
  ttlSecondsAfterFinished: 3600  # Удалить Job через час после завершения
  backoffLimit: 3  # Максимум 3 попытки
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: migrate
        image: postgres:16-alpine
        command:
        - /bin/sh
        - -c
        - |
          echo "Starting migration..."
          PGPASSWORD="${POSTGRES_PASSWORD}" psql -h "${POSTGRES_HOST}" -p "${POSTGRES_PORT}" -U "${POSTGRES_USER}" -d "${POSTGRES_DB}" -f /migration/migrate-bbox.sql
          if [ $? -eq 0 ]; then
            echo "Migration completed successfully!"
          else
            echo "Migration failed!"
            exit 1
          fi
        env:
        - name: POSTGRES_HOST
          value: "postgres"  # Сервис PostgreSQL в namespace infidraw
        - name: POSTGRES_PORT
          value: "5432"
        - name: POSTGRES_USER
          value: "infidraw"
        - name: POSTGRES_PASSWORD
          value: "infidraw_dev"
        - name: POSTGRES_DB
          value: "infidraw"
        volumeMounts:
        - name: migration-script
          mountPath: /migration
      volumes:
      - name: migration-script
        configMap:
          name: migrate-bbox-sql
