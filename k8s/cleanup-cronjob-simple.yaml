# Упрощенная версия без секретов - для dev окружения
apiVersion: batch/v1
kind: CronJob
metadata:
  name: cleanup-old-strokes
  namespace: infidraw
spec:
  # Запускать каждый день в 3:00 UTC (можно изменить на нужное время)
  # Формат: "минута час день месяц день_недели"
  # Примеры:
  # "0 3 * * *" - каждый день в 3:00
  # "0 0 * * 0" - каждое воскресенье в полночь
  # "0 2 1 * *" - первого числа каждого месяца в 2:00
  schedule: "0 3 * * *"
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 86400  # Удалить Job через сутки после завершения
      backoffLimit: 2
      template:
        spec:
          restartPolicy: OnFailure
          containers:
          - name: cleanup
            image: curlimages/curl:latest
            command:
            - /bin/sh
            - -c
            - |
              echo "Starting cleanup of old strokes..."
              response=$(curl -s -w "\n%{http_code}" -X POST \
                -H "Content-Type: application/json" \
                -H "x-admin-token: ${ADMIN_TOKEN}" \
                "${ADMIN_SERVICE_URL}/admin/cleanup-old?days=${CLEANUP_DAYS}")
              
              http_code=$(echo "$response" | tail -n1)
              body=$(echo "$response" | sed '$d')
              
              echo "Response code: $http_code"
              echo "Response body: $body"
              
              if [ "$http_code" -eq 200 ]; then
                echo "Cleanup completed successfully!"
                exit 0
              else
                echo "Cleanup failed with HTTP code: $http_code"
                exit 1
              fi
            env:
            - name: ADMIN_SERVICE_URL
              value: "http://admin-service:3000"  # URL admin-service в namespace infidraw
            - name: ADMIN_TOKEN
              value: "dev-admin-token-change-in-production"  # Измени на свой токен
            - name: CLEANUP_DAYS
              value: "7"  # Удалять записи старше 7 дней (неделя)
              # Измени на 30 для месяца
