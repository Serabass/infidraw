# –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ ¬´–≤–µ—á–Ω–æ–≥–æ¬ª canvas

–°—Ç–µ–∫ Postgres + Redis + MinIO –¥–ª—è –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ —Ä–∏—Å–æ–≤–∞–Ω–∏—è –Ω–æ—Ä–º–∞–ª–µ–Ω. –ü—Ä–æ–±–ª–µ–º–∞ –Ω–µ –≤ –≤—ã–±–æ—Ä–µ, –∞ –≤ —Ç–æ–º, —á—Ç–æ **–∑–∞–ø—Ä–æ—Å—ã –±—ã—Å—Ç—Ä–æ –ø—Ä–µ–≤—Ä–∞—â–∞—é—Ç—Å—è –≤ –º—è—Å–æ—Ä—É–±–∫—É**, –µ—Å–ª–∏ –Ω–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω: **—Ç–∞–π–ª ‚Üí —Å–Ω–∞–ø—à–æ—Ç ‚Üí –¥–µ–ª—å—Ç–∞ —Å–æ–±—ã—Ç–∏–π**.

–ù–∏–∂–µ ‚Äî —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –Ω–∞–±–æ—Ä —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π: —á—Ç–æ —É–∂–µ –≤–Ω–µ–¥—Ä–µ–Ω–æ –≤ –ø—Ä–æ–µ–∫—Ç–µ –∏ —á—Ç–æ –æ—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ –ø–æ—Ç–æ–º.

---

## 1. –ó–∞–ø—Ä–æ—Å—ã –ø–æ —Ç–∞–π–ª–∞–º, –Ω–µ –ø–æ bbox –≤ SQL

| –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è | –°—Ç–∞—Ç—É—Å | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|--------------|--------|-------------|
| –ù–µ –¥–µ–ª–∞—Ç—å `WHERE x BETWEEN ... AND y BETWEEN ...` –ø–æ –≤—Å–µ–º —Å–æ–±—ã—Ç–∏—è–º | ‚úÖ –í–Ω–µ–¥—Ä–µ–Ω–æ | –í **tile-service** —á—Ç–µ–Ω–∏–µ –∏–¥—ë—Ç –ø–æ `tile_events` –∏ `tile_id`; bbox —Ç–æ–ª—å–∫–æ fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö |
| –ù–∞ –∫–ª–∏–µ–Ω—Ç–µ/—Å–µ—Ä–≤–µ—Ä–µ —Å—á–∏—Ç–∞—Ç—å **–∫–∞–∫–∏–µ —Ç–∞–π–ª—ã –ø–æ–ø–∞–¥–∞—é—Ç –≤–æ –≤—å—é–ø–æ—Ä—Ç** ‚Üí —Å–ø–∏—Å–æ–∫ `tile_id` | ‚úÖ –í–Ω–µ–¥—Ä–µ–Ω–æ | –í –ë–î —Ö–æ–¥–∏–º –ø–æ `tile_id IN (...)` / `tile_id = ANY($1::bigint[])` |
| –ü—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–µ –∏–Ω–¥–µ–∫—Å—ã, –ª–∏–Ω–µ–π–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –æ—Ç —á–∏—Å–ª–∞ —Ç–∞–π–ª–æ–≤ | ‚úÖ –í–Ω–µ–¥—Ä–µ–Ω–æ | –°–º. —Ä–∞–∑–¥–µ–ª ¬´–ò–Ω–¥–µ–∫—Å—ã¬ª –Ω–∏–∂–µ |

---

## 2. tile_id –∫–∞–∫ –æ–¥–∏–Ω bigint –∏ –∏–Ω–¥–µ–∫—Å (tile_id, seq/id)

| –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è | –°—Ç–∞—Ç—É—Å | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|--------------|--------|-------------|
| –û–¥–∏–Ω `tile_id` (bigint), –Ω–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏—è (tile_x, tile_y, zoom) | ‚úÖ –í–Ω–µ–¥—Ä–µ–Ω–æ | –ö–æ–¥–∏—Ä–æ–≤–∫–∞: `(tileX + 500_000) * 1_000_000 + (tileY + 500_000)` |
| –ò–Ω–¥–µ–∫—Å –ø–æ `(tile_id, seq)` –∏–ª–∏ `(room_id, tile_id, id)` | ‚úÖ –í–Ω–µ–¥—Ä–µ–Ω–æ | –¢–∞–±–ª–∏—Ü–∞ `tile_events(room_id, tile_id, id, stroke_id, event_type, payload, ts)`; UNIQUE –ø–æ `(room_id, tile_id, id)` |
| –î–µ–ª—å—Ç–∞: ¬´–≤—Å—ë –≤ —Ç–∞–π–ª–µ, –≥–¥–µ `id > since_id`¬ª | ‚úÖ –í–Ω–µ–¥—Ä–µ–Ω–æ | –í tile-service –¥–µ–ª—å—Ç–∞ —Å—Ç—Ä–æ–∏—Ç—Å—è –∏–∑ `tile_events` –ø–æ `tile_id` –∏ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –ø–æ `sinceVersion` |

---

## 3. –ó–∞–ø—Ä–æ—Å –¥–µ–ª—å—Ç—ã –ø–æ –º–Ω–æ–≥–∏–º —Ç–∞–π–ª–∞–º (VALUES + JOIN)

| –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è | –°—Ç–∞—Ç—É—Å | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|--------------|--------|-------------|
| –£ –∫–∞–∂–¥–æ–≥–æ —Ç–∞–π–ª–∞ —Å–≤–æ–π `since_seq` / `since_id` | ‚úÖ –£—á—Ç–µ–Ω–æ | –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏/–≤–µ—Ä—Å–∏–∏ |
| –û–¥–∏–Ω –∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ `WITH req(tile_id, since_seq) AS (VALUES ...) JOIN tile_events` | üî∂ –ß–∞—Å—Ç–∏—á–Ω–æ | –°–µ–π—á–∞—Å: –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å `tile_id = ANY($1::bigint[])`, –∑–∞—Ç–µ–º –≤ –∫–æ–¥–µ —Ä–∞–∑–±–æ—Ä –ø–æ —Ç–∞–π–ª–∞–º; –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å VALUES+JOIN –¥–ª—è ¬´since_id per tile¬ª |

---

## 4. –°–Ω–∞–ø—à–æ—Ç + –¥–µ–ª—å—Ç–∞ –∑–∞ 1‚Äì2 –∑–∞–ø—Ä–æ—Å–∞

| –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è | –°—Ç–∞—Ç—É—Å | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|--------------|--------|-------------|
| –¢–∞–±–ª–∏—Ü–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ç–∞–π–ª–∞ (snapshot_seq, snapshot_url, last_seq) | ‚úÖ –ü–æ —Å–º—ã—Å–ª—É –µ—Å—Ç—å | `tile_snapshots(room_id, tile_x, tile_y, version, snapshot_url)`; —Å–Ω–∞–ø—à–æ—Ç –≤ MinIO –ø–æ `snapshot_url` |
| –ü–æ–ª—É—á–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏—è –Ω—É–∂–Ω—ã—Ö —Ç–∞–π–ª–æ–≤ ‚Üí –¥–µ–ª—å—Ç–∞ –ø–æ—Å–ª–µ snapshot_seq | ‚úÖ –í–Ω–µ–¥—Ä–µ–Ω–æ | GET /tiles –æ—Ç–¥–∞—ë—Ç —Å–Ω–∞–ø—à–æ—Ç + strokes (–¥–µ–ª—å—Ç–∞); –¥–∞–Ω–Ω—ã–µ –∏–∑ `tile_events` –ø–æ `tile_id` |
| Redis –∫–∞–∫ –∫—ç—à –¥–ª—è tile_state | ‚è≥ –ù–∞ –ø–æ—Ç–æ–º | –°–µ–π—á–∞—Å Redis ‚Äî pub/sub; –∫—ç—à tile_state –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∂–µ |

---

## 5. Payload: –Ω–µ —Ä–∞–∑–¥—É–≤–∞—Ç—å JSONB –¥–ª—è —Ç–æ—á–µ–∫

| –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è | –°—Ç–∞—Ç—É—Å | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|--------------|--------|-------------|
| –¢–æ—á–∫–∏ –Ω–µ –≤ JSONB (–∂–∏—Ä–Ω–æ, –º–µ–¥–ª–µ–Ω–Ω–æ, TOAST) | üî∂ –ß–∞—Å—Ç–∏—á–Ω–æ | –¢–æ—á–∫–∏ –≤ stroke –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É –≤ JSON; –¥–ª—è Redis —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è msgpack (event-store ‚Üí realtime) |
| Payload BYTEA (protobuf/msgpack), —Ç–æ—á–∫–∏ int16/int32 (√ó100) | ‚è≥ –ù–∞ –ø–æ—Ç–æ–º | –¢—Ä–µ–±—É–µ—Ç –¥–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç–∏ —Å –∫–ª–∏–µ–Ω—Ç–æ–º –∏ —Å–º–µ–Ω—ã API; —Å–º. PERF-ROADMAP.md |
| JSONB —Ç–æ–ª—å–∫–æ –¥–ª—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (tool, color, width) | ‚è≥ –ù–∞ –ø–æ—Ç–æ–º | –í–æ–∑–º–æ–∂–Ω–æ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ —Ñ–æ—Ä–º–∞—Ç–∞ |

---

## 6. –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ

| –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è | –°—Ç–∞—Ç—É—Å | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|--------------|--------|-------------|
| –ö–æ–≥–¥–∞ `tile_events` —Å—Ç–∞–Ω–µ—Ç –æ—á–µ–Ω—å –±–æ–ª—å—à–æ–π ‚Äî –ø–∞—Ä—Ç–∏—Ü–∏–∏ | ‚è≥ –ù–∞ –ø–æ—Ç–æ–º | HASH –ø–æ `tile_id` (32/64 –ø–∞—Ä—Ç–∏—Ü–∏–∏): —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞, –º–µ–Ω—å—à–∏–µ –∏–Ω–¥–µ–∫—Å—ã –∏ –≤–∞–∫—É—É–º |

---

## 7. –•–æ–ª–æ–¥–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ ¬´–Ω–∞–≤—Å–µ–≥–¥–∞¬ª

| –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è | –°—Ç–∞—Ç—É—Å | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|--------------|--------|-------------|
| –í Postgres ‚Äî ¬´–≥–æ—Ä—è—á–∏–π —Ö–≤–æ—Å—Ç¬ª (–ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–æ–±—ã—Ç–∏–π –ø–æ—Å–ª–µ —Å–Ω–∞–ø—à–æ—Ç–∞) | ‚è≥ –ù–∞ –ø–æ—Ç–æ–º | –°–µ–π—á–∞—Å –≤–µ—Å—å –ª–æ–≥ –≤ Postgres |
| –°—Ç–∞—Ä—ã–µ —Å–æ–±—ã—Ç–∏—è ‚Äî segment bundles –≤ MinIO (–ø–æ —Ç–∞–π–ª—É –∏ –¥–∏–∞–ø–∞–∑–æ–Ω—É seq) | ‚è≥ –ù–∞ –ø–æ—Ç–æ–º | Time-travel –±–µ–∑ ¬´SELECT * FROM –º–∏–ª–ª–∏–∞—Ä–¥–∞ —Å—Ç—Ä–æ–∫¬ª |
| tile_state / tile_segments —Ö—Ä–∞–Ω—è—Ç —Å—Å—ã–ª–∫–∏ –Ω–∞ —Å–µ–≥–º–µ–Ω—Ç—ã | ‚è≥ –ù–∞ –ø–æ—Ç–æ–º | –û—Ç–¥–µ–ª—å–Ω–∞—è —Ñ–∞–∑–∞ —Ä–∞–∑–≤–∏—Ç–∏—è |

---

## 8. Redis: —Ç–æ—á–µ—á–Ω–æ, –Ω–µ ¬´–∫—ç—à –≤—Å–µ–≥–æ¬ª

| –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è | –°—Ç–∞—Ç—É—Å | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|--------------|--------|-------------|
| –ö—ç—à tile_state (snapshot_seq, snapshot_url, last_seq) | ‚è≥ –ù–∞ –ø–æ—Ç–æ–º | –°–µ–π—á–∞—Å –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è |
| LRU ¬´hot tiles¬ª: –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–æ–±—ã—Ç–∏–π –ø–æ —Ç–∞–π–ª—É –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ re-join | ‚è≥ –ù–∞ –ø–æ—Ç–æ–º | –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ |
| Pub/Sub –∏–ª–∏ Streams –¥–ª—è realtime –ø–æ tile_id / region_id | ‚úÖ –í–Ω–µ–¥—Ä–µ–Ω–æ | Redis pub/sub –¥–ª—è stroke_events; realtime-service –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –∏ —Ä–∞—Å—Å—ã–ª–∞–µ—Ç –ø–æ WS |

---

## 9. –ë–∞—Ç—á–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π

| –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è | –°—Ç–∞—Ç—É—Å | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|--------------|--------|-------------|
| –ë–∞—Ç—á —Å–æ–±—ã—Ç–∏–π (20‚Äì50 ms –∏–ª–∏ 50‚Äì200 —Ç–æ—á–µ–∫) | ‚è≥ –ù–∞ –ø–æ—Ç–æ–º | –ö–ª–∏–µ–Ω—Ç –º–æ–∂–µ—Ç —Å–ª–∞—Ç—å –ø–æ –æ–¥–Ω–æ–º—É; –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –±—É—Ñ–µ—Ä –Ω–∞ API |
| –í—Å—Ç–∞–≤–∫–∞ –ø–∞—á–∫–æ–π `INSERT ... VALUES (...),(...),...` | üî∂ –ß–∞—Å—Ç–∏—á–Ω–æ | event-store –ø–∏—à–µ—Ç –≤ `tile_events` –ø–∞—á–∫–æ–π –ø–æ —Ç–∞–π–ª–∞–º –æ–¥–Ω–æ–≥–æ —à—Ç—Ä–∏—Ö–∞; –æ–±—â–∏–π –±–∞—Ç—á –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —à—Ç—Ä–∏—Ö–æ–≤ ‚Äî –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω |
| pgbouncer –ø—Ä–∏ –±–æ–ª—å—à–æ–º —á–∏—Å–ª–µ WS-–∫–æ–Ω–Ω–µ–∫—Ç–æ–≤ | ‚è≥ –ù–∞ –ø–æ—Ç–æ–º | –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–∏ —Ä–æ—Å—Ç–µ –Ω–∞–≥—Ä—É–∑–∫–∏ |

---

## 10. –ò–Ω–¥–µ–∫—Å—ã (–º–∏–Ω–∏–º—É–º)

| –¢–∞–±–ª–∏—Ü–∞ / –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è | –í –ø—Ä–æ–µ–∫—Ç–µ |
|----------------------|--------------|-----------|
| tile_events | PK / UNIQUE `(room_id, tile_id, id)` | ‚úÖ |
| tile_events | (tile_id, ts) —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –≤—ã–±–æ—Ä–∫–∞—Ö –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (–∞–Ω–∞–ª–∏—Ç–∏–∫–∞) | –ü–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ |
| tile_snapshots | –ò–Ω–¥–µ–∫—Å –ø–æ `(room_id, tile_x, tile_y)` | ‚úÖ |
| stroke_events | –ü–æ room_id; bbox —Ç–æ–ª—å–∫–æ –¥–ª—è fallback | ‚úÖ |

–õ–∏—à–Ω–∏–µ –∏–Ω–¥–µ–∫—Å—ã –Ω–µ –¥–æ–±–∞–≤–ª—è—Ç—å –±–µ–∑ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.

---

## –ò—Ç–æ–≥

- **–í–Ω–µ–¥—Ä–µ–Ω–æ:** –∑–∞–ø—Ä–æ—Å—ã –ø–æ **tile_id**, —Ç–∞–±–ª–∏—Ü–∞ **tile_events**, –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –Ω–∞ –º–Ω–æ–≥–æ —Ç–∞–π–ª–æ–≤ (`getTileEventsBatch`), —Å–Ω–∞–ø—à–æ—Ç + –¥–µ–ª—å—Ç–∞ –∏–∑ tile_events, –∏–Ω–¥–µ–∫—Å—ã, msgpack –Ω–∞ Redis, snapshot-worker (Go).
- **–ù–∞ –ø–æ—Ç–æ–º:** JSONB‚ÜíBYTEA/protobuf –¥–ª—è —Ç–æ—á–µ–∫, –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, —Ö–æ–ª–æ–¥–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ MinIO, Redis-–∫—ç—à tile_state, –±–∞—Ç—á–∏ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ, pgbouncer.

–ï—Å–ª–∏ —Å—Ç—Ä–æ–∏—à—å —Å–∏—Å—Ç–µ–º—É –≤–æ–∫—Ä—É–≥ **tile_id**, **snapshot_seq** –∏ **–¥–µ–ª—å—Ç—ã –ø–æ id/seq**, –∑–∞–ø—Ä–æ—Å—ã –æ—Å—Ç–∞—é—Ç—Å—è –±—ã—Å—Ç—Ä—ã–º–∏ –¥–∞–∂–µ –ø—Ä–∏ –¥–æ–ª–≥–æ–π –∂–∏–∑–Ω–∏ –¥–∞–Ω–Ω—ã—Ö.

–ü–æ–¥—Ä–æ–±–Ω–µ–µ –ø–æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –¥–∞–ª—å–Ω–µ–π—à–∏–º —à–∞–≥–∞–º ‚Äî —Å–º. **docs/PERF-ROADMAP.md**.
